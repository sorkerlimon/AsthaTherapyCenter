{% extends 'admin/admin_base.html' %}

{% block title %}Appointment Details - {{ appointment.name }} - Astha Therapy Center Admin{% endblock %}
{% block page_title %}Appointment Details{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <!-- Appointment Information Card -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-calendar-alt me-2"></i>Appointment Information
                </h6>
                <span class="badge {{ appointment.get_status_badge_class }} fs-6">
                    {{ appointment.get_status_display }}
                </span>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-gray-800 mb-3">
                            <i class="fas fa-user me-2"></i>Patient Information
                        </h6>
                        <div class="mb-2">
                            <strong>Full Name:</strong>
                            <span class="ms-2">{{ appointment.name }}</span>
                        </div>
                        <div class="mb-2">
                            <strong>Email:</strong>
                            <span class="ms-2">
                                <a href="mailto:{{ appointment.email }}" class="text-decoration-none">
                                    {{ appointment.email }}
                                </a>
                            </span>
                        </div>
                        <div class="mb-2">
                            <strong>Phone:</strong>
                            <span class="ms-2">
                                <a href="tel:{{ appointment.phone }}" class="text-decoration-none">
                                    {{ appointment.phone }}
                                </a>
                            </span>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <h6 class="text-gray-800 mb-3">
                            <i class="fas fa-medical-kit me-2"></i>Appointment Details
                        </h6>
                        <div class="mb-2">
                            <strong>Service:</strong>
                            <span class="ms-2 badge bg-info">{{ appointment.get_service_display }}</span>
                        </div>
                        <div class="mb-2">
                            <strong>Date:</strong>
                            <span class="ms-2">{{ appointment.appointment_date|date:"l, F d, Y" }}</span>
                        </div>
                        <div class="mb-2">
                            <strong>Status:</strong>
                            <span class="ms-2 badge {{ appointment.get_status_badge_class }}">
                                {{ appointment.get_status_display }}
                            </span>
                        </div>
                    </div>
                </div>

                {% if appointment.notes %}
                <hr>
                <div class="row">
                    <div class="col-12">
                        <h6 class="text-gray-800 mb-3">
                            <i class="fas fa-sticky-note me-2"></i>Additional Notes
                        </h6>
                        <div class="bg-light p-3 rounded">
                            <p class="mb-0">{{ appointment.notes|linebreaks }}</p>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-cogs me-2"></i>Actions
                </h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <a href="{% url 'astha_therapy_center_web:admin_appointment_edit' appointment.id %}" 
                           class="btn btn-warning w-100">
                            <i class="fas fa-edit me-1"></i>Edit
                        </a>
                    </div>
                    <div class="col-md-3">
                        <button type="button" class="btn btn-info w-100" data-bs-toggle="modal" data-bs-target="#statusModal">
                            <i class="fas fa-sync-alt me-1"></i>Update Status
                        </button>
                    </div>
                    <div class="col-md-3">
                        <a href="mailto:{{ appointment.email }}?subject=Appointment Confirmation - {{ appointment.appointment_date|date:'M d, Y' }}" 
                           class="btn btn-success w-100">
                            <i class="fas fa-envelope me-1"></i>Email Patient
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{% url 'astha_therapy_center_web:admin_appointment_delete' appointment.id %}" 
                           class="btn btn-danger w-100">
                            <i class="fas fa-trash me-1"></i>Delete
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar with Timeline and Quick Info -->
    <div class="col-lg-4">
        <!-- Timeline Card -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-history me-2"></i>Timeline
                </h6>
            </div>
            <div class="card-body">
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-marker bg-success"></div>
                        <div class="timeline-content">
                            <h6 class="timeline-title">Appointment Created</h6>
                            <p class="timeline-date">{{ appointment.created_at|date:"M d, Y H:i" }}</p>
                        </div>
                    </div>
                    
                    {% if appointment.updated_at != appointment.created_at %}
                    <div class="timeline-item">
                        <div class="timeline-marker bg-info"></div>
                        <div class="timeline-content">
                            <h6 class="timeline-title">Last Updated</h6>
                            <p class="timeline-date">{{ appointment.updated_at|date:"M d, Y H:i" }}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Quick Actions Card -->
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-bolt me-2"></i>Quick Navigation
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'astha_therapy_center_web:admin_appointment_list' %}" class="btn btn-outline-primary">
                        <i class="fas fa-list me-1"></i>All Appointments
                    </a>
                    <a href="{% url 'astha_therapy_center_web:admin_appointment_create' %}" class="btn btn-outline-success">
                        <i class="fas fa-plus me-1"></i>New Appointment
                    </a>
                    <a href="{% url 'astha_therapy_center_web:therapy_admin' %}" class="btn btn-outline-info">
                        <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Status Update Modal -->
<div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="statusModalLabel">Update Appointment Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Current status: <span class="badge {{ appointment.get_status_badge_class }}">{{ appointment.get_status_display }}</span></p>
                <div class="mb-3">
                    <label for="newStatus" class="form-label">New Status:</label>
                    <select class="form-control" id="newStatus">
                        <option value="pending" {% if appointment.status == 'pending' %}selected{% endif %}>Pending</option>
                        <option value="confirmed" {% if appointment.status == 'confirmed' %}selected{% endif %}>Confirmed</option>
                        <option value="completed" {% if appointment.status == 'completed' %}selected{% endif %}>Completed</option>
                        <option value="cancelled" {% if appointment.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateStatus()">Update Status</button>
            </div>
        </div>
    </div>
</div>

<style>
.timeline {
    position: relative;
    padding-left: 2rem;
}

.timeline-item {
    position: relative;
    margin-bottom: 2rem;
}

.timeline-marker {
    position: absolute;
    left: -2rem;
    top: 0;
    width: 12px;
    height: 12px;
    border-radius: 50%;
}

.timeline-content h6 {
    margin-bottom: 0.25rem;
    font-size: 0.9rem;
}

.timeline-date {
    font-size: 0.8rem;
    color: #6c757d;
    margin-bottom: 0;
}

.timeline::before {
    content: '';
    position: absolute;
    left: -1.75rem;
    top: 6px;
    bottom: 0;
    width: 2px;
    background: #dee2e6;
}
</style>

<script>
function updateStatus() {
    const newStatus = document.getElementById('newStatus').value;
    
    fetch(`{% url 'astha_therapy_center_web:admin_appointment_update_status' appointment.id %}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            status: newStatus
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal and reload page
            bootstrap.Modal.getInstance(document.getElementById('statusModal')).hide();
            location.reload();
        } else {
            alert('Error updating status: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while updating the status.');
    });
}
</script>

{% endblock content %}